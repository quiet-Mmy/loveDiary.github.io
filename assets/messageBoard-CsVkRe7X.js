import{d as L,r as R,M as I,f as S,g as y,h as C,i as E,e as T,o as k,I as F}from"./index-C7SrcRmC.js";const _="/assets/mm-Q0ou9mqY.mp4";var M=Object.defineProperty,H=(h,e,t)=>e in h?M(h,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):h[e]=t,s=(h,e,t)=>(H(h,typeof e!="symbol"?e+"":e,t),t);function D(){let h=document.createElement("canvas"),e=h.getContext("2d"),t=function(){let i=window.devicePixelRatio||1,a=e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1;return i/a}();return h.width=h.height=0,t}const A={getDevicePixelRatio:D};function z(h){let e=0;return h.forEach(t=>e+=t),e}function P(h){if(h.length===0)return null;let e=h.reduce((a,r)=>({...a,[r]:(a[r]||0)+1}),{}),t=0,i=null;for(const a in e)e[a]>t&&(t=e[a],i=parseInt(a));return i}function N(h,e){return h=Math.ceil(h),e=Math.floor(e),Math.floor(Math.random()*(e-h+1))+h}const V={sum:z,findMode:P,getRandomInt:N},m={};function X(h){return m[h]||(m[h]=document.createElement("img"),m[h].src=h),m[h]}const Y={imageElementFactory:X};function W(h,e){let t=0,i=h.length-1;for(;t<=i;){let a=Math.floor((t+i)/2);h[a].time<e.time?t=a+1:i=a-1}h.splice(t,0,e)}const K={insertBarrageByTime:W},d={Canvas:A,Math:V,Cache:Y,Algorithm:K};class B{constructor({id:e,time:t,text:i,fontSize:a,lineHeight:r,color:o,prior:n=!1,customRender:l,addition:g},c){s(this,"id"),s(this,"time"),s(this,"text"),s(this,"fontSize"),s(this,"lineHeight"),s(this,"color"),s(this,"prior"),s(this,"customRender"),s(this,"addition"),s(this,"br"),s(this,"top"),s(this,"left"),s(this,"width"),s(this,"height"),s(this,"sections",[]),this.id=e,this.time=t,this.text=i,this.fontSize=a,this.lineHeight=r,this.color=o,this.prior=n,this.customRender=l,this.addition=g,this.br=c,this.initBarrage()}initBarrage(){var e,t;const i=this.analyseText(this.text);let a,r=0,o=0;const n=[];i.forEach(l=>{var g,c;if(l.type==="image"&&(a=(g=this.br.barrageImages)==null?void 0:g.find(f=>`[${f.id}]`===l.value)))r+=a.width,o=o<a.height?a.height:o,n.push(new $({...a,leftOffset:d.Math.sum(n.map(f=>f.width))}));else{this.setCtxFont(this.br.ctx);const f=((c=this.br.ctx)==null?void 0:c.measureText(l.value).width)||0,u=this.fontSize*this.lineHeight;r+=f,o=o<u?u:o,n.push(new U({text:l.value,width:f,height:u,leftOffset:d.Math.sum(n.map(b=>b.width))}))}}),this.sections=n,this.width=((e=this.customRender)==null?void 0:e.width)??r,this.height=((t=this.customRender)==null?void 0:t.height)??o,this.sections.forEach(l=>{l.sectionType==="text"?l.topOffset=(this.height-this.fontSize)/2:l.topOffset=(this.height-l.height)/2})}analyseText(e){const t=[];for(;e;){const r=e.indexOf("]");if(r!==-1){const o=e.lastIndexOf("[",r);o!==-1?(o!==0&&t.push({type:"text",value:e.slice(0,o)}),t.push({type:r-o>1?"image":"text",value:e.slice(o,r+1)}),e=e.slice(r+1)):(t.push({type:"text",value:e.slice(0,r+1)}),e=e.slice(r+1))}else t.push({type:"text",value:e}),e=""}const i=[];let a="";for(let r=0;r<t.length;r++)t[r].type==="text"?a+=t[r].value:(a!==""&&(i.push({type:"text",value:a}),a=""),i.push(t[r]));return a!==""&&i.push({type:"text",value:a}),i}render(e){if(e.beginPath(),this.customRender){this.customRender.renderFn({ctx:e,barrage:this,br:this.br,imageElementFactory:d.Cache.imageElementFactory});return}this.br.devConfig.isRenderBarrageBorder&&(e.strokeStyle="#FF0000",e.strokeRect(this.left,this.top,this.width,this.height)),this.prior&&(this.br.renderConfig.priorBorderCustomRender?this.br.renderConfig.priorBorderCustomRender({ctx:e,barrage:this,br:this.br,imageElementFactory:d.Cache.imageElementFactory}):(e.strokeStyle="#89D5FF",e.strokeRect(this.left,this.top,this.width,this.height))),this.setCtxFont(e),e.fillStyle=this.color,this.sections.forEach(t=>{t.sectionType==="text"?e.fillText(t.text,this.left+t.leftOffset,this.top+t.topOffset):t.sectionType==="image"&&e.drawImage(d.Cache.imageElementFactory(t.url),this.left+t.leftOffset,this.top+t.topOffset,t.width,t.height)})}setCtxFont(e){e.font=`${this.br.renderConfig.fontWeight} ${this.fontSize}px ${this.br.renderConfig.fontFamily}`}}class U{constructor({text:e,width:t,height:i,leftOffset:a}){s(this,"sectionType","text"),s(this,"text"),s(this,"width"),s(this,"height"),s(this,"topOffset"),s(this,"leftOffset"),this.text=e,this.width=t,this.height=i,this.leftOffset=a}}class ${constructor({id:e,url:t,width:i,height:a,leftOffset:r}){s(this,"sectionType","image"),s(this,"id"),s(this,"url"),s(this,"width"),s(this,"height"),s(this,"topOffset"),s(this,"leftOffset"),this.id=e,this.url=t,this.width=i,this.height=a,this.leftOffset=r}}class x extends B{constructor(e,t){super(e,t),s(this,"barrageType"),s(this,"duration"),s(this,"endTime");const{barrageType:i,duration:a}=e;this.barrageType=i,this.duration=a,this.endTime=this.time+a,this.calcFixedBarrageLeft()}calcFixedBarrageLeft(){this.left=(this.br.canvasSize.width-this.width)/2}}class O extends B{constructor(e,t){super(e,t),s(this,"barrageType","scroll"),s(this,"originalLeft"),s(this,"originalRight"),s(this,"show",!0),s(this,"grade"),this.calcOriginal()}calcOriginal(){this.originalLeft=this.br.canvasSize.width+this.time/1e3*this.br.renderConfig.speed,this.originalRight=this.originalLeft+this.width}}class w extends B{constructor(e,t){super(e,t),s(this,"barrageType","senior"),s(this,"seniorBarrageConfig"),s(this,"vx"),s(this,"vy"),s(this,"actualStartLocation"),s(this,"actualEndLocation"),this.seniorBarrageConfig=e.seniorBarrageConfig,this.calcActualLocation()}calcActualLocation(){const{startLocation:e,endLocation:t,motionDuration:i}=this.seniorBarrageConfig;let a=(e.type||"PIXEL")==="PIXEL"?e.x:e.x*this.canvasSize.width,r=(e.type||"PIXEL")==="PIXEL"?e.y:e.y*this.canvasSize.height;e.offsetX&&(a+=e.offsetX),e.offsetY&&(r+=e.offsetY),this.actualStartLocation={x:a,y:r};let o=(t.type||"PIXEL")==="PIXEL"?t.x:t.x*this.canvasSize.width,n=(t.type||"PIXEL")==="PIXEL"?t.y:t.y*this.canvasSize.height;t.offsetX&&(o+=t.offsetX),t.offsetY&&(n+=t.offsetY),this.actualEndLocation={x:o,y:n},this.vx=(this.actualEndLocation.x-this.actualStartLocation.x)/i,this.vy=(this.actualEndLocation.y-this.actualStartLocation.y)/i}get canvasSize(){return this.br.canvasSize}}class q{constructor(e){s(this,"br"),s(this,"topRenderBarrages",[]),s(this,"bottomRenderBarrages",[]),this.br=e}getRenderFixedBarrages(e,t){const i=e.filter(n=>n.barrageType==="top"&&t>=n.time&&t<=n.endTime),a=e.filter(n=>n.barrageType==="bottom"&&t>=n.time&&t<=n.endTime);this.topRenderBarrages=this.topRenderBarrages.filter(n=>i.includes(n)),this.bottomRenderBarrages=this.bottomRenderBarrages.filter(n=>a.includes(n));const r=i.filter(n=>!this.topRenderBarrages.includes(n)),o=a.filter(n=>!this.bottomRenderBarrages.includes(n));return r.forEach(n=>{this.insertFixedBarrage(n)}),o.forEach(n=>{this.insertFixedBarrage(n)}),[...this.topRenderBarrages,...this.bottomRenderBarrages]}send(e){this.insertFixedBarrage(e)}insertFixedBarrage(e){let t=!1;if(e.barrageType==="top")if(this.topRenderBarrages.length===0)this.topRangeLength>=e.height&&(e.top=this.topRange[0],this.topRenderBarrages.push(e),t=!0);else for(let i=0;i<this.topRenderBarrages.length;i++){const a=this.topRenderBarrages[i];if(i===0&&a.top-this.topRange[0]>=e.height){e.top=this.topRange[0],this.topRenderBarrages.unshift(e),t=!0;break}if((i===this.topRenderBarrages.length-1?this.topRange[1]-a.top-a.height:this.topRenderBarrages[i+1].top-a.top-a.height)>=e.height){e.top=a.top+a.height,this.topRenderBarrages.splice(i+1,0,e),t=!0;break}}else if(this.bottomRenderBarrages.length===0)this.bottomRangeLength>=e.height&&(e.top=this.bottomRange[0]-e.height,this.bottomRenderBarrages.push(e),t=!0);else for(let i=0;i<this.bottomRenderBarrages.length;i++){const a=this.bottomRenderBarrages[i];if(i===0&&this.bottomRange[0]-a.top-a.height>=e.height){e.top=this.bottomRange[0]-e.height,this.bottomRenderBarrages.unshift(e),t=!0;break}if((i===this.bottomRenderBarrages.length-1?a.top-this.bottomRange[1]:a.top-this.bottomRenderBarrages[i+1].top-this.bottomRenderBarrages[i+1].height)>=e.height){e.top=a.top-e.height,this.bottomRenderBarrages.splice(i+1,0,e),t=!0;break}}e.prior&&!t&&(e.barrageType==="top"?(e.top=d.Math.getRandomInt(this.topRange[0],this.topRange[1]-e.height),this.topRenderBarrages.push(e),this.topRenderBarrages.sort((i,a)=>i.top-a.top)):(e.top=d.Math.getRandomInt(this.bottomRange[1],this.bottomRange[0]-e.height),this.bottomRenderBarrages.push(e),this.bottomRenderBarrages.sort((i,a)=>a.top-i.top)))}clearStoredBarrage(){this.topRenderBarrages=[],this.bottomRenderBarrages=[]}get middleHeightPoint(){return this.br.canvasSize.height/2}get topRange(){return[0,this.middleHeightPoint]}get topRangeLength(){return this.topRange[1]-this.topRange[0]}get bottomRange(){return[this.br.canvasSize.height,this.middleHeightPoint]}get bottomRangeLength(){return this.bottomRange[0]-this.bottomRange[1]}}class G{constructor(e){s(this,"br"),s(this,"realTracks",[]),s(this,"virtualTracks",[]),s(this,"realTrackHeight"),s(this,"realTrackNum"),s(this,"maxGrade"),s(this,"vtToVtsMap",new Map),s(this,"gradeToVtsMap",new Map),this.br=e}initTracks(e){this.resetTracks();const t=Math.floor(this.br.canvasSize.height*this.br.renderConfig.renderRegion/e);this.realTrackHeight=e,this.realTrackNum=t;for(let r=1;r<=t;r++)this.realTracks.push(new j(r,e));const i=this.realTracks.map(r=>r.id);let a=1;for(let r=1;r<=t;r++){const o=t-(r-1);for(let n=1;n<=o;n++)this.virtualTracks.push(new Q(a++,i.slice(n-1,n-1+r),this.realTracks.slice(n-1,n-1+r)))}this.isLogKeyData&&console.table([{item:"实际轨道高度",value:e},{item:"实际轨道数量",value:this.realTracks.length},{item:"虚拟轨道数量",value:this.virtualTracks.length}]),this.virtualTracks.forEach(r=>{this.vtToVtsMap.set(r,this.virtualTracks.filter(o=>o.grade<=this.maxGrade&&r.rtIdArr.some(n=>o.rtIdSet.has(n))))});for(let r=1;r<=t;r++)this.gradeToVtsMap.set(r,this.virtualTracks.filter(o=>o.grade===r))}layoutScrollBarrages(e){if(e.length===0)return;const t=d.Math.findMode(e.map(i=>Math.ceil(i.height)));this.maxGrade=Math.ceil(Math.max(...e.map(i=>i.height))/t),(!this.realTracks.length||!this.virtualTracks.length)&&this.initTracks(t),e.forEach(i=>{i.grade=Math.ceil(i.height/t)}),this.avoidOverlap?this.avoidOverlapLayout(e):this.allowOverlapLayout(e)}avoidOverlapLayout(e){const t=Date.now();this.virtualTracks.forEach(i=>i.clearBarrage()),e.forEach(i=>{const a=this.gradeToVtsMap.get(i.grade)||[];for(let r=0;r<a.length;r++){const o=a[r];if((this.vtToVtsMap.get(o)||[]).every(n=>{const l=n.getLastBarrage();return l?l.originalRight+this.minSpace<=i.originalLeft:!0})){i.show=!0,o.push(i),i.top=o.top;break}else i.show=!1}i.prior&&!i.show&&this.randomTrackBarrage(i)}),this.isLogKeyData&&console.log(`虚拟轨道算法花费时间：${Date.now()-t}ms`)}allowOverlapLayout(e){e.forEach(t=>{this.randomTrackBarrage(t)})}avoidOverlapInsert(e){let t=!1;const i=this.gradeToVtsMap.get(e.grade)||[];for(let a=0;a<i.length;a++){const r=i[a];if(r.isEmpty){e.show=!0,r.push(e),e.top=r.top,t=!0;break}else if(e.originalLeft<r.getByIndex(0).originalLeft){if(e.originalRight+this.minSpace<r.getByIndex(0).originalLeft){e.show=!0,r.barrages.unshift(e),e.top=r.top,t=!0;break}}else{const o=r.barrages.findIndex((n,l,g)=>{const c=g[l+1];return n.originalLeft<e.originalLeft&&(!c||e.originalLeft<c.originalLeft)});if(o!==-1){const n=r.barrages[o],l=r.barrages[o+1];if(n.originalRight+this.minSpace<e.originalLeft&&(!l||e.originalRight+this.minSpace<l.originalLeft)){e.show=!0,r.barrages.splice(o+1,0,e),e.top=r.top,t=!0;break}}}}t||this.randomTrackBarrage(e)}send(e){e.grade=Math.ceil(e.height/this.realTrackHeight),this.br.renderConfig.avoidOverlap?this.avoidOverlapInsert(e):this.randomTrackBarrage(e)}resetTracks(){this.realTracks=[],this.virtualTracks=[],this.vtToVtsMap.clear(),this.gradeToVtsMap.clear()}heightChangeReLayoutCalc(e){this.resetTracks(),this.layoutScrollBarrages(e)}randomTrackBarrage(e){const t=this.getRandomRealTrack();e.top=t.top,e.show=!0}get avoidOverlap(){return this.br.renderConfig.avoidOverlap}get isLogKeyData(){return this.br.devConfig.isLogKeyData}getRandomRealTrack(){return this.realTracks[d.Math.getRandomInt(0,this.realTracks.length-1)]}get minSpace(){return this.br.renderConfig.minSpace}}class j{constructor(e,t){s(this,"id"),s(this,"height"),this.id=e,this.height=t}get top(){return(this.id-1)*this.height}}class Q{constructor(e,t,i){s(this,"id"),s(this,"rtIdArr"),s(this,"rtIdSet"),s(this,"rtInstanceArr"),s(this,"barrages",[]),this.id=e,this.rtIdArr=t,this.rtIdSet=new Set(t),this.rtInstanceArr=i}getLastBarrage(){return this.barrages[this.barrages.length-1]}push(e){this.barrages.push(e)}clearBarrage(){this.barrages=[]}getByIndex(e){return this.barrages[e]}get grade(){return this.rtIdArr.length}get isEmpty(){return this.barrages.length===0}get top(){return this.rtInstanceArr[0].top}}class J{constructor({barrageRenderer:e}){s(this,"br"),s(this,"allBarrageInstances",[]),s(this,"fixedBarrageInstances",[]),s(this,"scrollBarrageInstances",[]),s(this,"seniorBarrageInstances",[]),s(this,"fixedBarrageLayout"),s(this,"virtualTrackAlgorithm"),this.br=e,this.fixedBarrageLayout=new q(this.br),this.virtualTrackAlgorithm=new G(this.br)}setBarrages(e){let t=e.map(i=>{switch(i.barrageType){case"top":case"bottom":return new x(i,this.br);case"scroll":return new O(i,this.br);case"senior":return new w(i,this.br)}});t=t.sort((i,a)=>i.time-a.time),this.allBarrageInstances=t,this.scrollBarrageInstances=t.filter(i=>i.barrageType==="scroll"),this.fixedBarrageInstances=t.filter(i=>["top","bottom"].includes(i.barrageType)),this.seniorBarrageInstances=t.filter(i=>i.barrageType==="senior"),this.virtualTrackAlgorithm.layoutScrollBarrages(this.scrollBarrageInstances)}getRenderBarrages(e){const t=this.getRenderScrollBarrages(e),i=this.getRenderFixedBarrages(e),a=this.getRenderSeniorBarrages(e);return[...t,...i,...a].sort((r,o)=>r.prior!==o.prior?r.prior?1:-1:r.time-o.time)}send(e){if(e.barrageType==="scroll"){const t=new O(e,this.br);d.Algorithm.insertBarrageByTime(this.scrollBarrageInstances,t),this.virtualTrackAlgorithm.send(t)}else if(e.barrageType==="top"||e.barrageType==="bottom"){const t=new x(e,this.br);d.Algorithm.insertBarrageByTime(this.fixedBarrageInstances,t),this.fixedBarrageLayout.send(t)}else if(e.barrageType==="senior"){const t=new w(e,this.br);d.Algorithm.insertBarrageByTime(this.seniorBarrageInstances,t)}}getRenderScrollBarrages(e){const t=e/1e3*this.br.renderConfig.speed,i=this.scrollBarrageInstances.filter(a=>a.show&&a.top!==void 0).filter(a=>a.originalRight-t>=0&&a.originalLeft-t<this.br.canvasSize.width);return i.forEach(a=>{a.left=a.originalLeft-t}),i}getRenderFixedBarrages(e){return this.fixedBarrageLayout.getRenderFixedBarrages(this.fixedBarrageInstances,e)}getRenderSeniorBarrages(e){const t=this.seniorBarrageInstances.filter(i=>e>=i.time&&e<=i.time+i.seniorBarrageConfig.totalDuration);return t.forEach(i=>{const a=i.time,r=a+i.seniorBarrageConfig.delay,o=r+i.seniorBarrageConfig.motionDuration;if(e>=a&&e<=r)i.left=i.actualStartLocation.x,i.top=i.actualStartLocation.y;else if(e>=r&&e<=o){const n=e-r;i.left=i.actualStartLocation.x+n*i.vx,i.top=i.actualStartLocation.y+n*i.vy}else i.left=i.actualEndLocation.x,i.top=i.actualEndLocation.y}),t}handleWidthChange(){this.fixedBarrageInstances.forEach(e=>e.calcFixedBarrageLeft()),this.scrollBarrageInstances.forEach(e=>e.calcOriginal())}handleHeightChange(){this.fixedBarrageLayout.clearStoredBarrage(),this.virtualTrackAlgorithm.heightChangeReLayoutCalc(this.scrollBarrageInstances)}resize(e){this.seniorBarrageInstances.forEach(t=>t.calcActualLocation()),e==="ONLY_WIDTH"?this.handleWidthChange():e==="ONLY_HEIGHT"?this.handleHeightChange():(this.handleWidthChange(),this.handleHeightChange())}renderConfigChange(e,t,i,a,r){e&&this.scrollBarrageInstances.forEach(o=>o.calcOriginal()),t&&this.fixedBarrageLayout.clearStoredBarrage(),(t||i)&&this.virtualTrackAlgorithm.resetTracks(),(e&&this.br.renderConfig.avoidOverlap||t||i||a||r&&this.br.renderConfig.avoidOverlap)&&this.virtualTrackAlgorithm.layoutScrollBarrages(this.scrollBarrageInstances)}}var p=(h=>(h[h.FIXED_DURATION_ERROR=1]="FIXED_DURATION_ERROR",h[h.SENIOR_TOTAL_ERROR=2]="SENIOR_TOTAL_ERROR",h[h.SENIOR_DELAY_ERROR=3]="SENIOR_DELAY_ERROR",h[h.SENIOR_MOTION_ERROR=4]="SENIOR_MOTION_ERROR",h))(p||{});class v extends Error{constructor(e){super(e.message),s(this,"code"),this.code=e.code}}class Z{constructor({container:e,video:t,barrages:i,barrageImages:a,renderConfig:r,devConfig:o}){s(this,"container"),s(this,"video"),s(this,"canvas"),s(this,"ctx"),s(this,"barrageImages"),s(this,"defaultRenderConfig",{heightReduce:0,speed:200,opacity:1,renderRegion:1,fontFamily:"Microsoft YaHei",fontWeight:"normal",avoidOverlap:!0,minSpace:10}),s(this,"renderConfig",this.defaultRenderConfig),s(this,"defaultDevConfig",{isRenderFPS:!1,isRenderBarrageBorder:!1,isLogKeyData:!1}),s(this,"devConfig",this.defaultDevConfig),s(this,"barrageLayoutCalculate",new J({barrageRenderer:this})),s(this,"isOpen",!0),s(this,"animationHandle"),s(this,"fps",""),s(this,"lastFrameTime"),s(this,"lastCalcTime",0),s(this,"lastContainerSize",{width:0,height:0}),s(this,"offscreenCanvas"),s(this,"offscreenCanvasCtx"),s(this,"dpr",d.Canvas.getDevicePixelRatio()),this.video=t,this.setRenderConfigInternal(r||{},!0),this.setDevConfig(o||{}),this.barrageImages=a,this.container=typeof e=="string"?document.getElementById(e):e,this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.offscreenCanvas=document.createElement("canvas"),this.offscreenCanvasCtx=this.offscreenCanvas.getContext("2d"),this.handleDOM(this.container,this.canvas,this.ctx),this.setBarrages(i),this.devConfig.isLogKeyData&&console.log("全局实例：",this)}handleDOM(e,t,i){e||console.error("Unable to obtain container element"),i||console.error("Unable to obtain CanvasRenderingContext2D"),!(!e||!i)&&(e.style.position="relative",t.style.position="absolute",t.style.left="0px",t.style.top="0px",t.style.pointerEvents="none",t.width=e.clientWidth,t.height=e.clientHeight-(this.renderConfig.heightReduce??0),e.appendChild(t),this.handleHighDprVague(t,i),this.offscreenCanvas.width=e.clientWidth,this.offscreenCanvas.height=e.clientHeight-(this.renderConfig.heightReduce??0),this.handleHighDprVague(this.offscreenCanvas,this.offscreenCanvasCtx))}handleHighDprVague(e,t){const i=e.width,a=e.height;e.width=i*this.dpr,e.height=a*this.dpr,e.style.width=i+"px",e.style.height=a+"px",t.scale(this.dpr,this.dpr),t.textBaseline="hanging"}send(e){const t=this.validateBarrageOption(e);if(t!==!0)throw t;this.barrageLayoutCalculate.send(e)}resize(){var e,t;this.handleDOM(this.container,this.canvas,this.ctx);const i={width:((e=this.container)==null?void 0:e.clientWidth)||0,height:((t=this.container)==null?void 0:t.clientHeight)||0},{width:a,height:r}=this.lastContainerSize,o=a!==i.width,n=r!==i.height;(o||n)&&(this.lastContainerSize=i,o&&!n?this.barrageLayoutCalculate.resize("ONLY_WIDTH"):!o&&n?this.barrageLayoutCalculate.resize("ONLY_HEIGHT"):this.barrageLayoutCalculate.resize("BOTH")),this.renderFrame()}setBarrages(e){var t,i;e&&(e=e.filter(a=>this.validateBarrageOption(a)===!0),this.barrageLayoutCalculate.setBarrages(e),this.lastContainerSize={width:((t=this.container)==null?void 0:t.clientWidth)||0,height:((i=this.container)==null?void 0:i.clientHeight)||0})}setRenderConfigInternal(e,t=!1){const i=Object.keys(e),a=i.includes("speed")&&e.speed!==this.renderConfig.speed,r=i.includes("heightReduce")&&e.heightReduce!==this.renderConfig.heightReduce,o=i.includes("renderRegion")&&e.renderRegion!==this.renderConfig.renderRegion,n=i.includes("avoidOverlap")&&e.avoidOverlap!==this.renderConfig.avoidOverlap,l=i.includes("minSpace")&&e.minSpace!==this.renderConfig.minSpace;Object.assign(this.renderConfig,e),!t&&(a||r||o||n)&&(r&&this.handleDOM(this.container,this.canvas,this.ctx),this.barrageLayoutCalculate.renderConfigChange(a,r,o,n,l)),!this.animationHandle&&!t&&this._render()}setRenderConfig(e){this.setRenderConfigInternal(e)}setDevConfig(e){Object.assign(this.devConfig,e)}_render(){if(!this.isOpen)return;let e=this.barrageLayoutCalculate.getRenderBarrages(this.progress);this.renderConfig.barrageFilter&&(e=e.filter(t=>this.renderConfig.barrageFilter(t))),this.offscreenCanvasCtx.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),this.offscreenCanvasCtx.globalAlpha=this.renderConfig.opacity,e.forEach(t=>{t.render(this.offscreenCanvasCtx)}),this.devConfig.isRenderFPS&&this.renderFps(),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.offscreenCanvas.width&&this.ctx.drawImage(this.offscreenCanvas,0,0,this.offscreenCanvas.width,this.offscreenCanvas.height,0,0,this.canvas.width/this.dpr,this.canvas.height/this.dpr),this.animationHandle&&requestAnimationFrame(()=>this._render())}_createAnimation(){!this.animationHandle&&this.isOpen&&(this.animationHandle=requestAnimationFrame(()=>this._render()))}get progress(){return this.videoStatus.currentTime}get videoStatus(){return{currentTime:this.video.currentTime*1e3,playing:!this.video.paused}}get canvasSize(){return{width:this.canvas.width/this.dpr,height:this.canvas.height/this.dpr}}renderFrame(){this.animationHandle||this._render()}play(){this._createAnimation()}pause(){this.animationHandle&&cancelAnimationFrame(this.animationHandle),this.animationHandle=void 0}switch(e){this.isOpen=e,e?this.videoStatus.playing?this._createAnimation():this._render():(this.animationHandle&&cancelAnimationFrame(this.animationHandle),this.animationHandle=void 0,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height))}renderFps(){const e=Date.now();this.lastFrameTime&&e-this.lastCalcTime>200&&(this.fps=`${Math.floor(1e3/(e-this.lastFrameTime))}FPS`,this.lastCalcTime=e),this.lastFrameTime=e,this.fps&&(this.offscreenCanvasCtx.font="bold 32px Microsoft YaHei",this.offscreenCanvasCtx.fillStyle="blue",this.offscreenCanvasCtx.fillText(this.fps,20,30))}validateBarrageOption(e){if((e.barrageType==="top"||e.barrageType==="bottom")&&e.duration<=0)return new v({code:p.FIXED_DURATION_ERROR,message:"The duration of the fixed barrage should be greater than 0"});if(e.barrageType==="senior"){const{totalDuration:t,delay:i,motionDuration:a}=e.seniorBarrageConfig;if(t<=0)return new v({code:p.SENIOR_TOTAL_ERROR,message:"The totalDuration of senior barrage should be greater than 0"});if(i<0)return new v({code:p.SENIOR_DELAY_ERROR,message:"The delay of senior barrage should be greater than or equal to 0"});if(a<0)return new v({code:p.SENIOR_MOTION_ERROR,message:"The motionDuration of senior barrage should be greater than or equal to 0"})}return!0}}const ee={id:"container"},ie=L({__name:"messageBoard",setup(h){const e=[{id:"e55b45c9-7f9e-48c9-9bba-4d3b53441976",barrageType:"scroll",time:100,text:"无边落木萧萧下",fontSize:34,lineHeight:1.2,color:"#FFFF00"},{id:"e55b45c9-7f9e-48c9-9bba-4d3b53441976",barrageType:"scroll",time:100,text:"不尽长江滚滚来",fontSize:28,lineHeight:1.2,color:"#FF6700"}],t=R(""),i=R(),a=R(),r=(g,c)=>(g=Math.ceil(g),c=Math.floor(c),Math.floor(Math.random()*(c-g+1))+g),o=()=>{e.push({id:"e55b45c9-7f9e-48c9-9bba-"+Math.random(),barrageType:"scroll",time:100,text:t.value,fontSize:r(16,32),lineHeight:1.2,color:"#FFFF23"}),l(),setTimeout(()=>{n()},1e3)};I(()=>{i.value=new Z({container:"container",video:a.value,barrages:e})});const n=()=>{var g;(g=i.value)==null||g.play()},l=()=>{var g;(g=i.value)==null||g.pause()};return(g,c)=>{const f=T("el-input"),u=T("el-button");return k(),S("div",ee,[y("video",{ref_key:"video",ref:a,id:"video",controls:"",autoplay:"",src:_,onPlay:n,onPause:l},null,544),y("div",null,[C(f,{"l-input":"",modelValue:t.value,"onUpdate:modelValue":c[0]||(c[0]=b=>t.value=b),placeholder:"输入你想发表的留言",clearable:""},null,8,["modelValue"]),C(u,{type:"primary",size:"default",onClick:o},{default:E(()=>[F("发 表")]),_:1})])])}}});export{ie as default};
